Vagrant.configure('2') do |config|

  # ---------- Hyper-V ----------
  config.vm.define 'hyper-v_vm' do |hv_vm|
    hv_vm.vm.box      = 'generic/ubuntu2204'
    hv_vm.vm.hostname = 'WiFiChallengeLab'

    hv_vm.vm.provider 'hyperv' do |hv|
      hv.vmname    = 'WiFiChallenge Lab v2.2'
      hv.maxmemory = 4096
      hv.memory    = 4096
      hv.cpus      = 4
    end

    # Step 1: install HWE kernel
    hv_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        apt-get install --install-recommends -y linux-generic-hwe-22.04
      SHELL
      privileged: true,
      run: 'once'

    # Step 2: coordinated reboot
    hv_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    # Step 3: main setup script
    hv_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

  # ---------- VirtualBox ----------
  config.vm.define 'virtualbox_vm' do |vb_vm|
    vb_vm.vm.box      = 'generic/ubuntu2204'
    vb_vm.vm.hostname = 'WiFiChallengeLab'

    vb_vm.vm.provider 'virtualbox' do |vb|
      vb.memory = 4096
      vb.cpus   = 4
      vb.name   = 'WiFiChallenge Lab v2.2'
    end

    vb_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        apt-get install --install-recommends -y linux-generic-hwe-22.04
      SHELL
      privileged: true,
      run: 'once'

    vb_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    vb_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

  # ---------- VMware ----------
  config.vm.define 'vmware_vm' do |vmw_vm|
    vmw_vm.vm.box      = 'generic/ubuntu2204'
    vmw_vm.vm.hostname = 'WiFiChallengeLab'

    vmw_vm.vm.provider 'vmware_desktop' do |v|
      v.linked_clone         = false
      v.clone_directory      = 'E:/VMWare'
      v.force_vmware_license = 'workstation'
      v.gui                  = true
      v.vmx['displayName']   = 'WiFiChallenge Lab v2.2'
      v.memory               = 4096
      v.cpus                 = 4
    end

    vmw_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        apt-get install --install-recommends -y linux-generic-hwe-22.04
      SHELL
      privileged: true,
      run: 'once'

    vmw_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    vmw_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

end
