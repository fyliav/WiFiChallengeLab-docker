Vagrant.configure('2') do |config|

  # ---------- Helper for conditional sync excluding .vagrant ----------
  def sync_all_except_vagrant(vm, base_host_path, base_guest_path)
    Dir.glob(File.join(base_host_path, '*')).each do |path|
      next unless File.directory?(path)
      next if File.basename(path) == '.vagrant'
      guest_subpath = File.join(base_guest_path, File.basename(path))
      vm.vm.synced_folder path, guest_subpath
    end
  end

  # ---------- Hyper-V ----------
  config.vm.define 'hyper-v_vm' do |hv_vm|
    hv_vm.vm.box      = 'generic/debian12'
    hv_vm.vm.hostname = 'WiFiChallengeLab'

    hv_vm.vm.provider 'hyperv' do |hv|
      hv.vmname    = 'WiFiChallenge Lab v2.3'
      hv.maxmemory = 4096
      hv.memory    = 4096
      hv.cpus      = 4
    end

    # Sync all host folders except .vagrant
    sync_all_except_vagrant(hv_vm, "../", "/media/WiFiChallenge")

    hv_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y
      SHELL
      privileged: true,
      run: 'once'

    hv_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    hv_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

  # ---------- VirtualBox ----------
  config.vm.define 'virtualbox_vm' do |vb_vm|
    vb_vm.vm.box      = 'generic/debian12'
    vb_vm.vm.hostname = 'WiFiChallengeLab'

    vb_vm.vm.provider 'virtualbox' do |vb|
      vb.memory = 4096
      vb.cpus   = 4
      vb.name   = 'WiFiChallenge Lab v2.3'
    end

    # Sync all host folders except .vagrant
    sync_all_except_vagrant(vb_vm, "../", "/media/WiFiChallenge")

    vb_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y
      SHELL
      privileged: true,
      run: 'once'

    vb_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    vb_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

  # ---------- VMware ----------
  config.vm.define 'vmware_vm' do |vmw_vm|
    vmw_vm.vm.box      = 'generic/debian12'
    vmw_vm.vm.hostname = 'WiFiChallengeLab'

    vmw_vm.vm.provider 'vmware_desktop' do |v|
      v.linked_clone         = false
      v.clone_directory      = 'E:/VMWare'
      v.force_vmware_license = 'workstation'
      v.gui                  = true
      v.vmx['displayName']   = 'WiFiChallenge Lab v2.3'
      v.memory               = 4096
      v.cpus                 = 4
    end

    # Sync all host folders except .vagrant
    sync_all_except_vagrant(vmw_vm, "../", "/media/WiFiChallenge")

    vmw_vm.vm.provision 'shell',
      inline: <<-SHELL,
        set -e
        apt-get update -y
        DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y
      SHELL
      privileged: true,
      run: 'once'

    vmw_vm.vm.provision 'reload', name: 'Reboot after HWE kernel'

    vmw_vm.vm.provision 'shell',
      path: './install.sh',
      privileged: true
  end

end
